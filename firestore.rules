rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null
        && request.auth.token.firebase != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    function isApprovedUser() {
      return signedIn() && (
        isAdmin()
        || exists(/databases/$(database)/documents/members/$(request.auth.uid))
      );
    }

    function isAdmin() {
      return signedIn() && (
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        || isOwner()
      );
    }

    function isOwner() {
      return signedIn() && exists(/databases/$(database)/documents/owners/$(request.auth.uid));
    }

    function userManageableStatus(value) {
      return value in ['requested', 'tentative', 'decline', 'withdrawn'];
    }

    function validStatus(value) {
      return value in ['requested', 'accept', 'tentative', 'decline', 'withdrawn', 'denied'];
    }

    function validRole(value) {
      return value in ['Tank', 'Healer', 'DPS'];
    }

    function validClass(value) {
      return value in [
        'Druid',
        'Hunter',
        'Mage',
        'Paladin',
        'Priest',
        'Rogue',
        'Shaman',
        'Warlock',
        'Warrior'
      ];
    }

    function validDay(value) {
      return value in [
        'Monday',
        'Tuesday',
        'Wednesday',
        'Thursday',
        'Friday',
        'Saturday',
        'Sunday'
      ];
    }

    function validHours(value) {
      return value is int && value >= 0 && value <= 23;
    }

    function validEndHour(value) {
      return value is int && value >= 1 && value <= 24;
    }

    function validSpecialization(value) {
      return value is string && value.size() > 1 && value.size() <= 40;
    }

    function validRaidDate(value) {
      return value is string && value.matches('^\\d{4}-\\d{2}-\\d{2}$');
    }

    function validSignupData(data) {
      return data.keys().hasOnly([
          'characterId',
          'profileCharacterKey',
          'profileCharacterName',
          'raidId',
          'raidName',
          'raidStart',
          'raidEnd',
          'raidDate',
          'phase',
          'runType',
          'raidSize',
          'status',
          'ownerUid',
          'createdAt',
          'updatedAt'
        ])
        && data.characterId is string
        && data.characterId.size() > 0
        && data.characterId.size() <= 80
        && (
          !('profileCharacterKey' in data)
          || (
            data.profileCharacterKey is string
            && data.profileCharacterKey.size() > 0
            && data.profileCharacterKey.size() <= 40
          )
        )
        && (
          !('profileCharacterName' in data)
          || (
            data.profileCharacterName is string
            && data.profileCharacterName.size() > 1
            && data.profileCharacterName.size() <= 24
          )
        )
        && data.raidId is string
        && data.raidId.size() > 5
        && data.raidName is string
        && data.raidName.size() > 2
        && data.raidName.size() <= 40
        && validHours(data.raidStart)
        && validEndHour(data.raidEnd)
        && data.raidStart < data.raidEnd
        && validRaidDate(data.raidDate)
        && validPhase(data.phase)
        && validRunType(data.runType)
        && validRaidSize(data.raidSize)
        && data.status is string
        && validStatus(data.status)
        && data.ownerUid is string
        && data.ownerUid.size() > 0
        && data.ownerUid.size() <= 128;
    }

    function validRunType(value) {
      return value in ['Progression', 'Farm', 'Weekly', 'Alt Run'];
    }

    function validCharacterData(data) {
      return data.keys().hasOnly([
          'profileName',
          'characterName',
          'wowClass',
          'role',
          'mainRole',
          'offRole',
          'mainSpecialization',
          'offSpecialization',
          'specialization',
          'armoryUrl',
          'progressionUrl',
          'preferredDay1',
          'preferredStart1',
          'preferredEnd1',
          'preferredDay2',
          'preferredStart2',
          'preferredEnd2',
          'altCharacters',
          'ownerUid',
          'ownerEmail',
          'createdAt',
          'updatedAt'
        ])
        && data.profileName is string
        && data.profileName.size() > 2
        && data.profileName.size() <= 60
        && data.characterName is string
        && data.characterName.size() > 1
        && data.characterName.size() <= 24
        && data.wowClass is string
        && validClass(data.wowClass)
        && data.role is string
        && validRole(data.role)
        && (
          (
            data.mainRole is string
            && validRole(data.mainRole)
            && data.offRole is string
            && validRole(data.offRole)
          )
          || (
            data.mainRole == null
            && data.offRole == null
          )
        )
        && (
          (
            data.mainSpecialization is string
            && validSpecialization(data.mainSpecialization)
            && data.offSpecialization is string
            && validSpecialization(data.offSpecialization)
          )
          || (
            data.mainSpecialization == null
            && data.offSpecialization == null
            && validSpecialization(data.specialization)
          )
        )
        && data.armoryUrl is string
        && data.armoryUrl.size() > 10
        && data.armoryUrl.matches('^https?://.*')
        && data.progressionUrl is string
        && (data.progressionUrl.size() == 0 || data.progressionUrl.matches('^https?://.*'))
        && (
          !('preferredDay1' in data)
          || (
            data.preferredDay1 is string
            && validDay(data.preferredDay1)
            && ('preferredStart1' in data)
            && ('preferredEnd1' in data)
            && validHours(data.preferredStart1)
            && validEndHour(data.preferredEnd1)
            && data.preferredStart1 < data.preferredEnd1
          )
        )
        && (
          !('preferredDay2' in data)
          || (
            data.preferredDay2 is string
            && validDay(data.preferredDay2)
            && ('preferredStart2' in data)
            && ('preferredEnd2' in data)
            && validHours(data.preferredStart2)
            && validEndHour(data.preferredEnd2)
            && data.preferredStart2 < data.preferredEnd2
          )
        )
        && (
          !('altCharacters' in data)
          || data.altCharacters is list
        )
        && data.ownerUid is string
        && data.ownerUid == request.auth.uid
        && (
          !('ownerEmail' in data)
          || data.ownerEmail == null
          || (
            data.ownerEmail is string
            && (
              data.ownerEmail.size() == 0
              || (
                request.auth.token.email is string
                && data.ownerEmail == request.auth.token.email
              )
            )
          )
        );
    }

    function validPhase(value) {
      return value is int && value >= 1 && value <= 5;
    }

    function validRaidSize(value) {
      return value is string && value.matches('^[0-9]{2}-man$');
    }

    function validSlotCount(value) {
      return value is int && value >= 0 && value <= 25;
    }

    function validRaidData(data) {
      return data.keys().hasOnly([
          'phase',
          'raidName',
          'raidDate',
          'runType',
          'raidStart',
          'raidEnd',
          'raidSize',
          'tankSlots',
          'healerSlots',
          'dpsSlots',
          'raidLeader',
          'softresLocked',
          'softresMaxReserves',
          'createdByUid',
          'createdAt',
          'updatedAt'
        ])
        && validPhase(data.phase)
        && data.raidName is string
        && data.raidName.size() > 2
        && data.raidName.size() <= 40
        && validRaidDate(data.raidDate)
        && validRunType(data.runType)
        && validHours(data.raidStart)
        && validEndHour(data.raidEnd)
        && data.raidStart < data.raidEnd
        && validRaidSize(data.raidSize)
        && (!('tankSlots' in data) || validSlotCount(data.tankSlots))
        && (!('healerSlots' in data) || validSlotCount(data.healerSlots))
        && (!('dpsSlots' in data) || validSlotCount(data.dpsSlots))
        && (!('raidLeader' in data) || (data.raidLeader is string && data.raidLeader.size() <= 40))
        && (!('softresLocked' in data) || data.softresLocked is bool)
        && (!('softresMaxReserves' in data) || (data.softresMaxReserves is int && data.softresMaxReserves >= 1 && data.softresMaxReserves <= 10))
        && data.createdByUid is string
        && data.createdByUid == request.auth.uid;
    }

    function validSoftReserveData(data) {
      return data.keys().hasOnly([
          'raidId',
          'raidName',
          'raidDate',
          'characterId',
          'characterName',
          'wowClass',
          'ownerUid',
          'items',
          'createdAt',
          'updatedAt'
        ])
        && data.raidId is string
        && data.raidId.size() > 5
        && data.raidName is string
        && data.raidName.size() > 2
        && data.raidName.size() <= 40
        && data.characterId is string
        && data.characterId.size() > 0
        && data.characterName is string
        && data.characterName.size() <= 24
        && data.items is list
        && data.items.size() >= 1
        && data.items.size() <= 10;
    }

    match /signups/{signupId} {
      allow read: if isApprovedUser();

      allow create: if isApprovedUser()
        && (
          isAdmin()
          || request.resource.data.ownerUid == request.auth.uid
        )
        && validSignupData(request.resource.data)
        && (isAdmin() || userManageableStatus(request.resource.data.status))
        && request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp;

      allow update: if isApprovedUser()
        && (
          isAdmin()
          || resource.data.ownerUid == request.auth.uid
        )
        && request.resource.data.ownerUid == resource.data.ownerUid
        && validSignupData(request.resource.data)
        && (isAdmin() || userManageableStatus(request.resource.data.status))
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.updatedAt is timestamp;

      allow delete: if isApprovedUser()
        && (isAdmin() || resource.data.ownerUid == request.auth.uid);
    }

    match /raids/{raidId} {
      allow read: if isApprovedUser();

      allow create: if isAdmin()
        && validRaidData(request.resource.data)
        && request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp;

      allow update: if isAdmin()
        && validRaidData(request.resource.data)
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.updatedAt is timestamp;

      allow delete: if isAdmin();
    }

    match /softreserves/{reserveId} {
      allow read: if isApprovedUser();

      allow create: if validSoftReserveData(request.resource.data)
        && request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp
        && (
          isAdmin()
          || (
            isApprovedUser()
            && request.resource.data.ownerUid == request.auth.uid
            && !(get(/databases/$(database)/documents/raids/$(request.resource.data.raidId)).data.softresLocked == true)
          )
        );

      allow update: if validSoftReserveData(request.resource.data)
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.updatedAt is timestamp
        && (
          isAdmin()
          || (
            isApprovedUser()
            && resource.data.ownerUid == request.auth.uid
            && request.resource.data.ownerUid == request.auth.uid
            && !(get(/databases/$(database)/documents/raids/$(request.resource.data.raidId)).data.softresLocked == true)
          )
        );

      allow delete: if isAdmin()
        || (
          isApprovedUser()
          && resource.data.ownerUid == request.auth.uid
          && !(get(/databases/$(database)/documents/raids/$(resource.data.raidId)).data.softresLocked == true)
        );
    }

    match /characters/{characterId} {
      allow read: if isApprovedUser();

      allow create: if isApprovedUser()
        && validCharacterData(request.resource.data)
        && request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp;

      allow update: if isApprovedUser()
        && (
          resource.data.ownerUid == request.auth.uid
          || (
            request.auth.token.email is string
            && resource.data.ownerEmail is string
            && resource.data.ownerEmail == request.auth.token.email
          )
        )
        && request.resource.data.ownerUid == request.auth.uid
        && validCharacterData(request.resource.data)
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.updatedAt is timestamp;

      allow delete: if isAdmin()
        || (
          isApprovedUser()
          && (
            resource.data.ownerUid == request.auth.uid
            || (
              request.auth.token.email is string
              && resource.data.ownerEmail is string
              && resource.data.ownerEmail == request.auth.token.email
            )
          )
        );
    }

    match /members/{uid} {
      allow read: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow create: if isAdmin()
        || (
          signedIn()
          && request.auth.uid == uid
          && request.resource.data.uid == uid
          && request.resource.data.role == 'member'
        );
      allow update: if isAdmin()
        || (
          signedIn()
          && request.auth.uid == uid
          && request.resource.data.uid == uid
          && request.resource.data.role == 'member'
        );
      allow delete: if isAdmin();
    }

    match /admins/{uid} {
      allow read: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow create, update, delete: if isAdmin();
    }

    match /owners/{uid} {
      allow read: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow create, update, delete: if isOwner();
    }
  }
}
